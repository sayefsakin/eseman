{
  "$schema": "https://vega.github.io/schema/vega/v6.json",
  "description": "Scrollable Gantt Chart with API Data",
  "width": 600,
  "height": 200,
  "padding": 5,
  "autosize": {"type": "fit", "resize": true},
  
  "signals": [
    {
      "name": "bins",
      "value": 1000,
      "description": "Number of bins "
    },
    {
      "name": "apiUrl",
      "value": "http://127.0.0.1:8080/get-data-in-range",
      "description": "Base API URL"
    },
    {
      "name": "trackArray",
      "update": "data('trackData.trackObj.track')"
    },
    {
      "name": "numTracks",
      "update": "length(trackArray)"
    },
    {
      "name": "trackHeight",
      "update": "height / numTracks"
    }
  ],
  
  "data": [
    {
      "name": "rawData",
      "url": {
        // "signal": "apiUrl + '?begin=' + beginTime + '&end=' + endTime + '&tracks=' + tracks + '&bins=' + bins"
        "signal": "apiUrl + '?bins=' + bins"
      },
      "format": {"type": "json"},
      "transform": [
        {
          "type": "formula",
          "expr": "datum.metadata.begin",
          "as": "metaBegin"
        },
        {
          "type": "formula", 
          "expr": "datum.metadata.end",
          "as": "metaEnd"
        },
        {
          "type": "formula",
          "expr": "datum.metadata.bins",
          "as": "metaBins"
        }
      ]
    },
    {
      "name": "trackData",
      "source": "rawData",
      "transform": [
        {
          "type": "project",
          "fields": ["data"]
        },
        {
          "type": "flatten",
          "fields": ["data"]
        },
        {
          "type": "project",
          "fields": ["data.track", "data.utils"],
          "as": ["track", "utils"]
        }
      ]
    },
    {
      "name": "processedData",
      "source": "trackData",
      "transform": [
        {
          "type": "formula",
          "expr": "sequence(0, length(datum.utils))",
          "as": "binIndices"
        },
        {
          "type": "flatten",
          "fields": ["binIndices"]
        },
        {
          "type": "formula",
          "expr": "datum.binIndices",
          "as": "binIndex"
        },
        {
          "type": "formula",
          "expr": "datum.utils[datum.binIndex]",
          "as": "utilValue"
        },
        {
          "type": "formula",
          "expr": "parseFloat(datum.utilValue)",
          "as": "utilFloat"
        },
        {
          "type": "filter",
          "expr": "datum.utilFloat > 0"
        },
        {
          "type": "formula",
          "expr": "data('rawData')[0].metaBegin",
          "as": "timeBegin"
        },
        {
          "type": "formula",
          "expr": "data('rawData')[0].metaEnd", 
          "as": "timeEnd"
        },
        {
          "type": "formula",
          "expr": "data('rawData')[0].metaBins",
          "as": "totalBins"
        },
        {
          "type": "formula",
          "expr": "(datum.timeEnd - datum.timeBegin) / datum.totalBins",
          "as": "binDuration"
        },
        {
          "type": "formula",
          "expr": "datum.timeBegin + (datum.binIndex * datum.binDuration)",
          "as": "timeStart"
        },
        {
          "type": "formula",
          "expr": "datum.timeStart + datum.binDuration",
          "as": "timeEnd"
        },
        {
          "type": "formula",
          "expr": "datum.utilFloat >= 1.0 ? 'solid' : 'partial'",
          "as": "barType"
        }
      ]
    }
  ],
  
  "scales": [
    {
      "name": "xScale",
      "type": "utc",
      "domain": {"signal": "[data('rawData')[0] ? data('rawData')[0].metaBegin : 0, data('rawData')[0] ? data('rawData')[0].metaEnd : 100]"},
      "range": "width",
      "nice": false
    },
    {
      "name": "yScale", 
      "type": "band",
      "domain": {"data": "processedData", "field": "track"},
      "range": [0, {"signal": "height"}],
      "padding": 0.1
    },
    {
      "name": "colorScale",
      "type": "ordinal",
      "domain": ["solid", "partial"],
      "range": ["#000000", "#9ca3af"]
    }
  ],
  
  "axes": [
    {
      "orient": "bottom",
      "scale": "xScale",
      "title": "Time",
      "format": "%s",
      "labelOverlap": "greedy"
    },
    { 
      "orient": "left", 
      "scale": "yScale", 
      "title": "Tracks",
      "grid": true,
      "bandPosition": "0"
    }
  ],
  
  "marks": [
    {
      "type": "group",
      "from": {"data": "processedData"},
      "encode": {
        "update": {
          "x": {"scale": "xScale", "field": "timeStart"},
          "x2": {"scale": "xScale", "field": "timeEnd"},
          "y": {"scale": "yScale", "field": "track"},
          "height": {"scale": "yScale", "band": 1},
          "fill": {"scale": "colorScale", "field": "barType"}
        }
      }
    }
  ]
}